<!DOCTYPE html>
<!--
Copyright 2018 The Go Authors. All rights reserved.
Use of this source code is governed by a BSD-style
license that can be found in the LICENSE file.
-->
<html>
  <head>
    <meta charset="utf-8" />
    <title>Go wasm</title>
  </head>

  <body>
    <!--
	Add the following polyfill for Microsoft Edge 17/18 support:
	<script src="https://cdn.jsdelivr.net/npm/text-encoding@0.7.0/lib/encoding.min.js"></script>
	(see https://caniuse.com/#feat=textencoder)
	-->
    <script src="wasm_exec.js"></script>
    <script>
      if (!WebAssembly.instantiateStreaming) {
        // polyfill
        WebAssembly.instantiateStreaming = async (resp, importObject) => {
          const source = await (await resp).arrayBuffer();
          return await WebAssembly.instantiate(source, importObject);
        };
      }

      // The WASM module will call this function when it's ready
      window.loadSection = (identifier, callback) => {
        const urlParams = new URLSearchParams(window.location.search);
        const shouldFetch = urlParams.get("debug") === "true" ? false : true;

        if (shouldFetch) {
          const base = document.getElementById("base").value;
          fetch(base + identifier)
            .then((response) => response.text())
            .then((text) => {
              callback(text, null);
            })
            .catch((err) => {
              callback(null, err);
            });
        } else {
          const text = document.getElementById("codeArea").value;
          callback(text, null);
        }
      };

      const go = new Go();
      let mod, inst;
      WebAssembly.instantiateStreaming(fetch("test.wasm"), go.importObject)
        .then((result) => {
          mod = result.module;
          inst = result.instance;
          go.run(inst);
          document.getElementById("runButton").disabled = false;
        })
        .catch((err) => {
          document.getElementById("output").value = err;
        });

      const exec = (sectionId) => {
        return new Promise((resolve, reject) => {
          window.execSection(sectionId, (value, err) => {
            if (err) {
              reject(err);
            } else {
              try {
                result = JSON.parse(value);
                resolve(result);
              } catch (e) {
                reject(e);
              }
            }
          });
        });
      };

      function render(result, err) {
        if (err) {
          console.error(err);
          document.getElementById("output").value = err;
          return;
        }

        const output = JSON.stringify(result, null, 2);
        document.getElementById("output").value = output;
      }

      async function run() {
        console.clear();

        let output = "";
        try {
          const result = await exec("entrypoint.jabl");
          render(result, null);
        } catch (e) {
          render(null, e);
        }
      }
    </script>

    <h1>JABL</h1>

    <h2>Base URL</h2>
    <input id="base" type="text" value="https://raw.githubusercontent.com/jasoncabot/fabled-story-book/main/assets/example01/" placeholder="https://example.com/book1/" />

    <h2>Input</h2>
    <textarea id="codeArea" rows="10" cols="80"></textarea>

    <h2>Output</h2>
    <textarea id="output" rows="10" cols="80"></textarea>

    <p>
      <button onClick="run();" id="runButton" disabled>Run</button>
    </p>
  </body>
</html>
